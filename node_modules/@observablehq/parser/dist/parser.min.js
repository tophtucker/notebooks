// @observablehq/parser v6.1.0 Copyright 2023 Observable, Inc.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("acorn"),require("acorn-walk")):"function"==typeof define&&define.amd?define(["exports","acorn","acorn-walk"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).observablehq=e.observablehq||{},e.acorn,e.acorn.walk)}(this,(function(e,t,s){"use strict";var r=new Set(["Array","ArrayBuffer","atob","AudioContext","Blob","Boolean","BigInt","btoa","clearInterval","clearTimeout","console","crypto","CustomEvent","DataView","Date","decodeURI","decodeURIComponent","devicePixelRatio","document","encodeURI","encodeURIComponent","Error","escape","eval","fetch","File","FileList","FileReader","Float32Array","Float64Array","Function","Headers","Image","ImageData","Infinity","Int16Array","Int32Array","Int8Array","Intl","isFinite","isNaN","JSON","Map","Math","NaN","Number","navigator","Object","parseFloat","parseInt","performance","Path2D","Promise","Proxy","RangeError","ReferenceError","Reflect","RegExp","cancelAnimationFrame","requestAnimationFrame","Set","setInterval","setTimeout","String","Symbol","SyntaxError","TextDecoder","TextEncoder","this","TypeError","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray","undefined","unescape","URIError","URL","WeakMap","WeakSet","WebSocket","Worker","window"]),n=s.make({Import(){},ViewExpression(e,t,s){s(e.id,t,"Identifier")},MutableExpression(e,t,s){s(e.id,t,"Identifier")}});function i(e){return"FunctionExpression"===e.type||"FunctionDeclaration"===e.type||"ArrowFunctionExpression"===e.type||"Program"===e.type}function a(e){return"BlockStatement"===e.type||"ForInStatement"===e.type||"ForOfStatement"===e.type||"ForStatement"===e.type||i(e)}function o(e){return"FunctionExpression"===e.type||"FunctionDeclaration"===e.type}function p(e,t){const r={type:"Program",body:[e.body]},i=new Map,{references:a}=e;return s.simple(r,{CallExpression:e=>{const{callee:s,arguments:r}=e;if("Identifier"!==s.type||s.name!==t||a.indexOf(s)<0)return;if(1!==r.length||!("Literal"===r[0].type&&/^['"]/.test(r[0].raw)||"TemplateLiteral"===r[0].type&&0===r[0].expressions.length))throw Object.assign(new SyntaxError(`${t} requires a single literal string argument`),{node:e});const[n]=r,o="Literal"===n.type?n.value:n.quasis[0].value.cooked,p={start:n.start,end:n.end};i.has(o)?i.get(o).push(p):i.set(o,[p])}},n),i}class c extends t.Parser{constructor(e,...t){super(Object.assign({ecmaVersion:13},e),...t)}enterScope(e){return 2&e&&++this.O_function,super.enterScope(e)}exitScope(){return 2&this.currentScope().flags&&--this.O_function,super.exitScope()}parseForIn(e,t){return 1===this.O_function&&e.await&&(this.O_async=!0),super.parseForIn(e,t)}parseAwait(){return 1===this.O_function&&(this.O_async=!0),super.parseAwait()}parseYield(e){return 1===this.O_function&&(this.O_generator=!0),super.parseYield(e)}parseImport(e){return this.next(),e.specifiers=this.parseImportSpecifiers(),this.type===t.tokTypes._with&&(this.next(),e.injections=this.parseImportSpecifiers()),this.expectContextual("from"),e.source=this.type===t.tokTypes.string?this.parseExprAtom():this.unexpected(),this.finishNode(e,"ImportDeclaration")}parseImportSpecifiers(){const e=[],s=new Set;let r=!0;for(this.expect(t.tokTypes.braceL);!this.eat(t.tokTypes.braceR);){if(r)r=!1;else if(this.expect(t.tokTypes.comma),this.afterTrailingComma(t.tokTypes.braceR))break;const n=this.startNode();n.view=this.eatContextual("viewof"),n.mutable=!n.view&&this.eatContextual("mutable"),n.imported=this.parseIdent(),this.checkUnreserved(n.imported),this.checkLocal(n.imported),this.eatContextual("as")?(n.local=this.parseIdent(),this.checkUnreserved(n.local),this.checkLocal(n.local)):n.local=n.imported,this.checkLValSimple(n.local,"let"),s.has(n.local.name)&&this.raise(n.local.start,`Identifier '${n.local.name}' has already been declared`),s.add(n.local.name),e.push(this.finishNode(n,"ImportSpecifier"))}return e}parseExprAtom(e){return this.parseMaybeKeywordExpression("viewof","ViewExpression")||this.parseMaybeKeywordExpression("mutable","MutableExpression")||super.parseExprAtom(e)}startCell(){this.O_function=0,this.O_async=!1,this.O_generator=!1,this.strict=!0,this.enterScope(14)}finishCell(e,t,s){return s&&this.checkLocal(s),e.id=s,e.body=t,e.async=this.O_async,e.generator=this.O_generator,this.exitScope(),this.finishNode(e,"Cell")}parseCell(e,s){const r=new c({},this.input,this.start);let n=r.getToken(),i=null,a=null;return this.startCell(),n.type===t.tokTypes._import&&r.getToken().type!==t.tokTypes.parenL?i=this.parseImport(this.startNode()):n.type!==t.tokTypes.eof&&n.type!==t.tokTypes.semi&&(n.type===t.tokTypes.name&&("viewof"!==n.value&&"mutable"!==n.value||(n=r.getToken(),n.type!==t.tokTypes.name&&r.unexpected()),n=r.getToken(),n.type===t.tokTypes.eq&&(a=this.parseMaybeKeywordExpression("viewof","ViewExpression")||this.parseMaybeKeywordExpression("mutable","MutableExpression")||this.parseIdent(),n=r.getToken(),this.expect(t.tokTypes.eq))),n.type===t.tokTypes.braceL?i=this.parseBlock():(i=this.parseExpression(),null!==a||"FunctionExpression"!==i.type&&"ClassExpression"!==i.type||(a=i.id))),this.semicolon(),s&&this.expect(t.tokTypes.eof),this.finishCell(e,i,a)}parseTopLevel(e){return this.parseCell(e,!0)}toAssignable(e,t,s){return"MutableExpression"===e.type?e:super.toAssignable(e,t,s)}checkLocal(e){const t=e.id||e;(r.has(t.name)||"arguments"===t.name)&&this.raise(t.start,`Identifier '${t.name}' is reserved`)}checkUnreserved(e){return"viewof"!==e.name&&"mutable"!==e.name||this.raise(e.start,`Unexpected keyword '${e.name}'`),super.checkUnreserved(e)}checkLValSimple(e,t,s){return super.checkLValSimple("MutableExpression"===e.type?e.id:e,t,s)}unexpected(e){this.raise(null!=e?e:this.start,this.type===t.tokTypes.eof?"Unexpected end of input":"Unexpected token")}parseMaybeKeywordExpression(e,t){if(this.isContextual(e)){const e=this.startNode();return this.next(),e.id=this.parseIdent(),this.finishNode(e,t)}}}const l=new t.TokContext("`",!0,!0,(e=>h.call(e)));class u extends c{constructor(...e){super(...e),this.type=t.tokTypes.backQuote,this.exprAllowed=!1}initialContext(){return[l]}parseCell(e){this.startCell(),this.type===t.tokTypes.eof&&(this.value="");const s=this.startNode();s.expressions=[];let r=this.parseTemplateElement({isTagged:true});for(s.quasis=[r];this.type!==t.tokTypes.eof;)this.expect(t.tokTypes.dollarBraceL),s.expressions.push(this.parseExpression()),this.expect(t.tokTypes.braceR),s.quasis.push(r=this.parseTemplateElement({isTagged:true}));return r.tail=!0,this.next(),this.finishNode(s,"TemplateLiteral"),this.expect(t.tokTypes.eof),this.finishCell(e,s,null)}}function h(){e:for(;this.pos<this.input.length;this.pos++)switch(this.input.charCodeAt(this.pos)){case 92:this.pos<this.input.length-1&&++this.pos;break;case 36:if(123===this.input.charCodeAt(this.pos+1)){if(this.pos===this.start&&this.type===t.tokTypes.invalidTemplate)return this.pos+=2,this.finishToken(t.tokTypes.dollarBraceL);break e}}return this.finishToken(t.tokTypes.invalidTemplate,this.input.slice(this.start,this.pos))}class f extends t.Parser{constructor(e,...t){super(Object.assign({ecmaVersion:12},e),...t)}enterScope(e){return 2&e&&++this.O_function,super.enterScope(e)}exitScope(){return 2&this.currentScope().flags&&--this.O_function,super.exitScope()}parseForIn(e,t){return 1===this.O_function&&e.await&&(this.O_async=!0),super.parseForIn(e,t)}parseAwait(){return 1===this.O_function&&(this.O_async=!0),super.parseAwait()}parseYield(e){return 1===this.O_function&&(this.O_generator=!0),super.parseYield(e)}parseTopLevel(e){return this.O_function=0,this.O_async=!1,this.O_generator=!1,this.strict=!0,this.enterScope(14),e.body=this.parseExpression(),e.input=this.input,e.async=this.O_async,e.generator=this.O_generator,this.exitScope(),this.finishNode(e,"CellTag")}}function d(e,p,c=r){if(e.body)if("ImportDeclaration"===e.body.type)e.references=e.body.injections?e.body.injections.map((e=>e.imported)):[];else try{e.references=function(e,t){const r={type:"Program",body:[e.body]},p=new Map,c=new Set(t),l=[];function u(e,t){const s=p.get(e);return!!s&&s.has(t)}function h(e,t){const s=p.get(e);s?s.add(t.name):p.set(e,new Set([t.name]))}function f(e){e.params.forEach((t=>d(t,e))),e.id&&h(e,e.id)}function d(e,t){switch(e.type){case"Identifier":h(t,e);break;case"ObjectPattern":e.properties.forEach((e=>d(e,t)));break;case"ArrayPattern":e.elements.forEach((e=>e&&d(e,t)));break;case"Property":d(e.value,t);break;case"RestElement":d(e.argument,t);break;case"AssignmentPattern":d(e.left,t);break;default:throw new Error("Unrecognized pattern type: "+e.type)}}function y(e){h(r,e.local)}function m(e,t){let s=e.name;if("undefined"!==s){for(let r=t.length-2;r>=0;--r){if("arguments"===s&&o(t[r]))return;if(u(t[r],s))return;"ViewExpression"===t[r].type&&(s=`viewof ${(e=t[r]).id.name}`),"MutableExpression"===t[r].type&&(s=`mutable ${(e=t[r]).id.name}`)}if(!c.has(s)){if("arguments"===s)throw Object.assign(new SyntaxError("arguments is not allowed"),{node:e});l.push(e)}}}function b(e,t){if(e)switch(e.type){case"Identifier":case"VariablePattern":for(const s of t)if(u(s,e.name))return;if("MutableExpression"===t[t.length-2].type)return;throw Object.assign(new SyntaxError(`Assignment to constant variable ${e.name}`),{node:e});case"ArrayPattern":for(const s of e.elements)b(s,t);return;case"ObjectPattern":for(const s of e.properties)b(s,t);return;case"Property":return void b(e.value,t);case"RestElement":return void b(e.argument,t)}}function x(e,t){b(e.left,t)}return s.ancestor(r,{VariableDeclaration:(e,t)=>{let s=null;for(let r=t.length-1;r>=0&&null===s;--r)("var"===e.kind?i(t[r]):a(t[r]))&&(s=t[r]);e.declarations.forEach((e=>d(e.id,s)))},FunctionDeclaration:(e,t)=>{let s=null;for(let e=t.length-2;e>=0&&null===s;--e)i(t[e])&&(s=t[e]);h(s,e.id),f(e)},Function:f,ClassDeclaration:(e,t)=>{let s=null;for(let e=t.length-2;e>=0&&null===s;e--)i(t[e])&&(s=t[e]);h(s,e.id)},Class:function(e){e.id&&h(e,e.id)},CatchClause:function(e){e.param&&d(e.param,e)},ImportDefaultSpecifier:y,ImportSpecifier:y,ImportNamespaceSpecifier:y},n),s.ancestor(r,{VariablePattern:m,Identifier:m},n),s.ancestor(r,{AssignmentExpression:x,AssignmentPattern:x,UpdateExpression:function(e,t){b(e.argument,t)},ForOfStatement:x,ForInStatement:x},n),l}(e,c)}catch(e){if(e.node){const s=t.getLineInfo(p,e.node.start);e.message+=` (${s.line}:${s.column})`,e.pos=e.node.start,e.loc=s,delete e.node}throw e}else e.references=[];return e}function y(e,s){if(e.body&&"ImportDeclaration"!==e.body.type)try{e.fileAttachments=p(e,"FileAttachment"),e.databaseClients=p(e,"DatabaseClient"),e.secrets=p(e,"Secret"),e.notificationClients=p(e,"NotificationClient")}catch(e){if(e.node){const r=t.getLineInfo(s,e.node.start);e.message+=` (${r.line}:${r.column})`,e.pos=e.node.start,e.loc=r,delete e.node}throw e}else e.fileAttachments=new Map,e.databaseClients=new Map,e.secrets=new Map,e.notificationClients=new Map;return e}const m=Symbol("start"),b=Symbol("modifier"),x=Symbol("function"),k=Symbol("name");e.CellParser=c,e.TemplateCellParser=u,e.parseCell=function(e,{tag:t,raw:s,globals:r,...n}={}){let i;if(null!=t&&e){i=u.parse(e,n);const a=f.parse(t,n);d(a,t,r),y(a,t),i.tag=a,i.raw=!!s}else i=c.parse(e,n);return d(i,e,r),y(i,e),i},e.peekId=function(e){let s,r=m;try{for(const n of t.Parser.tokenizer(e,{ecmaVersion:11})){switch(r){case m:case b:if(n.type===t.tokTypes.name){if(r===m&&("viewof"===n.value||"mutable"===n.value||"async"===n.value)){r=b;continue}r=k,s=n;continue}if(n.type===t.tokTypes._function||n.type===t.tokTypes._class){r=x;continue}break;case k:if(n.type===t.tokTypes.eq)return s.value;break;case x:if(n.type===t.tokTypes.star)continue;if(n.type===t.tokTypes.name&&n.end<e.length)return n.value}return}}catch(e){return}},e.walk=n,Object.defineProperty(e,"__esModule",{value:!0})}));
